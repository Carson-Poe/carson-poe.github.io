---
title: "Practice"
author: "Carson Poe"
date: "12/23/2020"
output: html_document
---
---
title: "Hyperparameter Tuning - Food Consumption"
output: html_document
editor_options: 
  chunk_output_type: inline
chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = FALSE, message = FALSE, cache = TRUE, dpi = 180, fig.width = 8, fig.height = 5)

library(tidymodels)
library(tidyverse)
library(RColorBrewer)
library(countrycode)
library(janitor)
library(GGally)
```


[Julia Silge Youtube HyperTune](https://www.youtube.com/watch?v=muf3-hrahHs&ab_channel=JuliaSilge)

## Explore Data

Get data, take a look. 

```{r}
food_consumption <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-18/food_consumption.csv")

knitr::kable(head(food_consumption))
```

Here, we're prepping the data. We use a function from the country code package 
that takes a country and matches it with the continent, all while creating a new
variable called continent. Really awesome package that can take country names, 
codes and many more. In fact. Let me look. Yeah, tons of codes to use.

Okay, so we line up country with continent, the we remove co2 emissions, 
and this next part is pretty great as well. Essentially, we've got a tall tbl 
at first, but pivot wider takes all the food_category names that are originally in 
one column and places them in rows with their associated consumption values. 

Next we clean the names. And then we create a binary indicator variable for 
when a country is in canada. Again we do this by creating a new variable with mutate
and then use the amazing function case_when(). 

Remove country, remove continent, now that we have asia or not asia and finally
wrap up by changing our columns / predictors that are characters into factors. 

How clean! How easy! 

```{r}

food <- food_consumption %>% 
    mutate(continent = countrycode(country, 
                                   origin = 'country.name', 
                                   destination = 'continent')) %>% 
    select(-co2_emmission) %>% 
    pivot_wider(names_from = food_category, 
                values_from = consumption) %>%
    clean_names() %>% 
    mutate(asia = case_when(continent =='Asia' ~ 'Asia',
                            TRUE ~ 'Other')) %>% 
    select(-country, -continent) %>% 
    mutate_if(is.character, factor)

```

This function gives us a scatter plot map of all our variables. This is effective here
becuase we have all continuous variables. From the GGally package. 

```{r pressure, echo=FALSE}

ggscatmat(food, columns = 1:11, color = 'asia', alpha = .6)


```

## Tune Hyperparameters

Create 30 random w/replacement samples. Get our model set up. Setting mtry to tune
and min_n to tune. Then tune grid our model spec. 

```{r}

set.seed(1234)

food_boot <- bootstraps(food, times = 30)

rf_spec <- rand_forest(mode = 'classification', 
            mtry = tune(),
            trees = 1000,
            min_n = tune()) %>% 
          set_engine('ranger')

rf_grid <- tune_grid(asia ~.,
  object = rf_spec,
  resamples = food_boot
)

```

Get metrics and plot. 

```{r}

rf_grid %>% 
  collect_metrics() %>% 
  filter(.metric == 'roc_auc') %>% 
  ggplot(mapping = aes(x = mtry, y = min_n)) +
  geom_point(aes(color = mean), size = 3, shape = 15) +
  scale_color_distiller(palette = 'Spectral') +
  theme_dark()

rf_grid %>% 
  show_best('roc_auc')

```


Thank you, Julia Silge! Find more of her work [here](https://juliasilge.com/)

**-Carson Poe**